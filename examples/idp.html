<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web5 Profile Creation</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-200 dark:bg-slate-800">

  <div class="screen hidden mx-auto mt-20 p-6 bg-white dark:bg-gray-900 rounded-xl shadow-md max-w-sm"
    id="landing_page">
    <div class="text-4xl text-gray-600 dark:text-gray-200 mb-8 font-bold">Web Wallet</div>

  </div>

  <div class="screen hidden mx-auto mt-20 p-6 bg-white dark:bg-gray-900 rounded-xl shadow-md max-w-sm"
    id="choose_identities">
    <div class="space-y-4">

      <div class="text-xl text-gray-600 dark:text-gray-200 font-bold">Sign in to DIDChat</div>
      <p class="text-gray-600 dark:text-gray-200">Choose the profiles you'd like to connect to DIDChat.</p>

      <div id="identity_selector" class="flex flex-col divide-y divide-gray-400/25">

        <!-- Example Pseudonomous Author Profile -->
        <div class="py-2 flex flex-row">
          <div class="flex">
            <div class="inline-flex items-center">
              <label class="relative flex cursor-pointer items-center rounded-full p-3" for="checkbox-1"
                data-ripple-dark="true">
                <input type="checkbox"
                  class="before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-blue-500 checked:bg-blue-500 checked:before:bg-blue-500 hover:before:opacity-10"
                  id="checkbox-1"> <!-- checked="">-->
                <div
                  class="pointer-events-none absolute top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"
                    stroke="currentColor" stroke-width="1">
                    <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
              </label>
            </div>
          </div>
          <div class="flex flex-1">
            <div class="flex items-center space-x-4 text-gray-600 dark:text-gray-200">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10">
                <path fill-rule="evenodd"
                  d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
                  clip-rule="evenodd" />
              </svg>
              <div class="font-medium">
                <div>Ash Garrett</div>
                <div class="text-sm text-gray-500 dark:text-gray-500">Author Pen Name</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Example Family Profile -->
        <div class="py-2 flex flex-row">
          <div class="flex">
            <div class="inline-flex items-center">
              <label class="relative flex cursor-pointer items-center rounded-full p-3" for="checkbox-2"
                data-ripple-dark="true">
                <input type="checkbox"
                  class="before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-blue-500 checked:bg-blue-500 checked:before:bg-blue-500 hover:before:opacity-10"
                  id="checkbox-2"> <!-- checked="">-->
                <div
                  class="pointer-events-none absolute top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"
                    stroke="currentColor" stroke-width="1">
                    <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
              </label>
            </div>
          </div>
          <div class="flex flex-1">
            <div class="flex items-center space-x-4 text-gray-600 dark:text-gray-200">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10">
                <path fill-rule="evenodd"
                  d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
                  clip-rule="evenodd" />
              </svg>
              <div class="font-medium">
                <div>Asmara</div>
                <div class="text-sm text-gray-500 dark:text-gray-500">Family Profile</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Example Work Profile -->
        <div class="py-2 flex flex-row">
          <div class="flex">
            <div class="inline-flex items-center">
              <label class="relative flex cursor-pointer items-center rounded-full p-3" for="checkbox-3"
                data-ripple-dark="true">
                <input type="checkbox"
                  class="before:content[''] peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-blue-gray-200 transition-all before:absolute before:top-2/4 before:left-2/4 before:block before:h-12 before:w-12 before:-translate-y-2/4 before:-translate-x-2/4 before:rounded-full before:bg-blue-gray-500 before:opacity-0 before:transition-opacity checked:border-blue-500 checked:bg-blue-500 checked:before:bg-blue-500 hover:before:opacity-10"
                  id="checkbox-3"> <!-- checked="">-->
                <div
                  class="pointer-events-none absolute top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"
                    stroke="currentColor" stroke-width="1">
                    <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
              </label>
            </div>
          </div>
          <div class="flex flex-1">
            <div class="flex items-center space-x-4 text-gray-600 dark:text-gray-200">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10">
                <path fill-rule="evenodd"
                  d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
                  clip-rule="evenodd" />
              </svg>
              <div class="font-medium">
                <div>Asmara Gebre</div>
                <div class="text-sm text-gray-500 dark:text-gray-500">Work Profile</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button id="choose_identities_next_button" class="w-full py-3 bg-blue-600 text-white rounded-lg">Next</button>

    </div>

  </div>

  <div class="screen hidden mx-auto mt-20 p-6 bg-white dark:bg-gray-900 rounded-xl shadow-md max-w-sm"
    id="permissions_request">
    <div class="space-y-4">

      <div class="text-xl text-gray-600 dark:text-gray-200 font-bold">Permissions Requested</div>
      <div class="text-gray-600 dark:text-gray-200">
        For each of the profiles you selected, DIDChat will be able to:

        <ul role="list" class="m-2">
          <li class="flex justify-between gap-x-6 py-1.5">
            <div class="flex min-w-0 gap-x-4">
              <div class="mt-1 flex items-center gap-x-2.5">
                <div class="flex-none rounded-full bg-emerald-500/20 p-1">
                  <div class="h-1.5 w-1.5 rounded-full bg-emerald-500"></div>
                </div>
                <p class="text-sm leading-5 text-gray-300">View and edit your profile</p>
              </div>
            </div>
            <div class="shrink-0 flex flex-col justify-center">
              <span
                class="inline-flex items-center justify-center w-6 h-6 text-sm font-semibold text-blue-800 dark:text-blue-400 rounded-full bg-blue-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-300">
                <svg class=" w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                  viewBox="0 0 20 20">
                  <path
                    d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
                </svg>
                <span class="sr-only">Learn more about this permission</span>
              </span>
            </div>
          </li>
          <li class="flex justify-between gap-x-6 py-1.5">
            <div class="flex min-w-0 gap-x-4">
              <div class="mt-1 flex items-center gap-x-2.5">
                <div class="flex-none rounded-full bg-emerald-500/20 p-1">
                  <div class="h-1.5 w-1.5 rounded-full bg-emerald-500"></div>
                </div>
                <p class="text-sm leading-5 text-gray-300">View and edit your contacts</p>
              </div>
            </div>
            <div class="shrink-0 flex flex-col justify-center">
              <span
                class="inline-flex items-center justify-center w-6 h-6 text-sm font-semibold text-blue-800 dark:text-blue-400 rounded-full bg-blue-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-300">
                <svg class=" w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                  viewBox="0 0 20 20">
                  <path
                    d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
                </svg>
                <span class="sr-only">Learn more about this permission</span>
              </span>
            </div>
          </li>
          <li class="flex justify-between gap-x-6 py-1.5">
            <div class="flex min-w-0 gap-x-4">
              <div class="mt-1 flex items-center gap-x-2.5">
                <div class="flex-none rounded-full bg-emerald-500/20 p-1">
                  <div class="h-1.5 w-1.5 rounded-full bg-emerald-500"></div>
                </div>
                <p class="text-sm leading-5 text-gray-300">View and edit your chats</p>
              </div>
            </div>
            <div class="shrink-0 flex flex-col justify-center">
              <span
                class="inline-flex items-center justify-center w-6 h-6 text-sm font-semibold text-blue-800 dark:text-blue-400 rounded-full bg-blue-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors duration-300">
                <svg class=" w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                  viewBox="0 0 20 20">
                  <path
                    d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
                </svg>
                <span class="sr-only">Learn more about this permission</span>
              </span>
            </div>
          </li>
        </ul>
      </div>

      <div class="flex flex-row space-x-2">
        <button id="permissions_request_back_button" class="w-full py-3 bg-blue-600 text-white rounded-lg">Back</button>
        <button id="permissions_request_approve_button"
          class="w-full py-3 bg-emerald-500 text-white rounded-lg">Approve</button>
      </div>
    </div>
  </div>

  <div
    class="screen hidden mx-auto mt-20 p-6 md:px-12 bg-white dark:bg-gray-900 rounded-xl shadow-md max-w-full md:max-w-[521px]"
    id="pin_challenge">
    <div class="space-y-4">
      <div class="text-xl text-gray-600 dark:text-gray-200 font-bold">Security Verification</div>
      <p class="text-gray-600 dark:text-gray-200">To finish connecting, go back to DIDChat and enter this security code.
      </p>
      <div class="pin-entry flex space-x-2.5 justify-center">
        <input
          class="text-gray-800 dark:text-gray-200 text-center text-4xl p-0 my-0 w-[63px] h-[63px] md:w-[95px] md:h-[95px] border-2 focus:border-[3px] border-solid rounded-2xl border-gray-200 dark:border-gray-700 focus:border-blue-400 dark:focus:hover:border-blue-400 focus:outline-none focus:shadow-none hover:border-gray-300 dark:hover:border-white/25 bg-transparent transition-colors duration-500"
          type="tel" value="">
        <input
          class="text-gray-800 dark:text-gray-200 text-center text-4xl p-0 my-0 w-[63px] h-[63px] md:w-[95px] md:h-[95px] border-2 focus:border-[3px] border-solid rounded-2xl border-gray-200 dark:border-gray-700 focus:border-blue-400 dark:focus:hover:border-blue-400 focus:outline-none focus:shadow-none hover:border-gray-300 dark:hover:border-white/25 bg-transparent transition-colors duration-500"
          type="tel" value="">
        <input
          class="text-gray-800 dark:text-gray-200 text-center text-4xl p-0 my-0 w-[63px] h-[63px] md:w-[95px] md:h-[95px] border-2 focus:border-[3px] border-solid rounded-2xl border-gray-200 dark:border-gray-700 focus:border-blue-400 dark:focus:hover:border-blue-400 focus:outline-none focus:shadow-none hover:border-gray-300 dark:hover:border-white/25 bg-transparent transition-colors duration-500"
          type="tel" value="">
        <input
          class="text-gray-800 dark:text-gray-200 text-center text-4xl p-0 my-0 w-[63px] h-[63px] md:w-[95px] md:h-[95px] border-2 focus:border-[3px] border-solid rounded-2xl border-gray-200 dark:border-gray-700 focus:border-blue-400 dark:focus:hover:border-blue-400 focus:outline-none focus:shadow-none hover:border-gray-300 dark:hover:border-white/25 bg-transparent transition-colors duration-500"
          type="tel" value="">
      </div>

      <div class="pin-entry flex space-x-2.5 py-2 justify-center">
        <div>
          <span
            class="inline-flex items-center rounded-md bg-blue-50 dark:bg-blue-400/10 px-2 py-1 text-xs font-medium text-blue-700 dark:text-blue-500 ring-1 ring-inset ring-blue-700/10 dark:ring-blue-700/30">NOTE</span>
        </div>
        <p class="text-gray-600 dark:text-gray-200">Your
          profiles will not be connected until you enter this code in DIDChat.
        </p>
      </div>
      <button id="pin_challenge_next_button" class="w-full py-3 bg-blue-600 text-white rounded-lg">Done</button>
    </div>
  </div>

  <script type="module">
    import { ConnectLink, ConnectProtocol } from '/packages/agent/dist/browser.mjs';
    import { IdentityAgent } from '/packages/identity-agent/dist/browser.mjs';
    import { LevelStore } from '/packages/common/dist/browser.mjs';

    const agent = await IdentityAgent.create();

    // Start agent for the first time.
    await agent.start({ passphrase: 'test' });

    console.log('Agent DID:', agent.agentDid);



    // // Create three identities, each of which is stored in a new tenant.
    // const careerIdentity = await agent.identityManager.create({
    //   name: 'Career',
    //   didMethod: 'key',
    //   kms: 'local'
    // });

    // const familyIdentity = await agent.identityManager.create({
    //   name: 'Family',
    //   didMethod: 'key',
    //   kms: 'local'
    // });

    // const socialIdentity = await agent.identityManager.create({
    //   name: 'Social',
    //   didMethod: 'key',
    //   kms: 'local'
    // });

    // // Import just the Identity metadata for the new identities to the Identity Agent's tenant.
    // await agent.identityManager.import({ identity: careerIdentity, context: agent.agentDid });
    // await agent.identityManager.import({ identity: familyIdentity, context: agent.agentDid });
    // await agent.identityManager.import({ identity: socialIdentity, context: agent.agentDid });

    export const profileProtocol = {
      protocol: "http://garfield.com/profile.schema.json",
      types: {
        profile: {
          schema: "http://garfield.com/profile.schema.json",
          dataFormats: ["application/json"],
        },
      },
      structure: {
        profile: {
          $actions: [
            {
              who: "anyone",
              can: "read",
            },
            // TODO: remove the following rule.
            // This only exists currently due to a bug where ManagedIdentities
            // aren't being considered the DWN's tentant.
            {
              who: "anyone",
              can: "write",
            },
          ],
        },
      },
      published: true,
    };

    // const storedIdentities = await agent.identityManager.list();
    // console.log(storedIdentities)
    // const storedIdentityDids2 = storedIdentities.map(identity => identity.did);

    // const identityDid = storedIdentityDids2[0];
    // const profile = {
    //   displayName: 'Ash Garrett',
    //   description: 'Author Pen Name'
    // };

    // const identityDid = storedIdentityDids2[1];
    // const profile = {
    //   displayName: 'Asmara',
    //   description: 'Family Profile'
    // };

    // const identityDid = storedIdentityDids2[2];
    // const profile = {
    //   displayName: 'Asmara Gebre',
    //   description: 'Work Profile'
    // };

    // console.log(identityDid);
    // import { Web5 } from '/packages/api/dist/browser.mjs';
    // const web5 = new Web5({ agent, appDid: identityDid })

    // // Check whether this Identity already has the Profile protocol configured.
    // const { protocols: profileProtocolConfigured } = await web5.dwn.protocols.query({
    //   message: {
    //     filter: {
    //       protocol: profileProtocol.protocol,
    //     },
    //   },
    // });

    // // If the Profile protocol is not configured, configure it.
    // if (profileProtocolConfigured.length === 0) {
    //   const { status: protocolConfigureStatus } = await web5.dwn.protocols.configure({
    //     message: {
    //       definition: profileProtocol,
    //     },
    //   });
    //   if (protocolConfigureStatus.code !== 202) {
    //     throw new Error(`Failed to configure Profile protocol: (${protocolConfigureStatus.code}) ${protocolConfigureStatus.detail}`);
    //   }
    //   console.log('Profile protocol configured.');
    // }

    // // Check whether a Profile has been created for this Identity.
    // const { records: profileRecords } = await web5.dwn.records.query({
    //   message: {
    //     filter: {
    //       protocol: profileProtocol.protocol,
    //       schema: profileProtocol.types.profile.schema
    //     },
    //   },
    // });

    // // If a Profile has not been created for this Identity, create one.
    // if (profileRecords.length === 0) {
    //   // TODO: Prompt the user for a display name.

    //   // Create a Profile record for this Identity.
    //   const { status: profileCreateStatus } = await web5.dwn.records.create({
    //     data: profile,
    //     message: {
    //       protocol: profileProtocol.protocol,
    //       protocolPath: 'profile',
    //       schema: profileProtocol.types.profile.schema
    //     }
    //   });
    //   if (profileCreateStatus.code !== 202) {
    //     throw new Error(`Failed to create Profile: (${profileCreateStatus.code}) ${profileCreateStatus.detail}`);
    //   }
    //   console.log('Profile created.');
    // }






    const dataStore = new LevelStore('DATA/AGENT/TEMP_CONNECT'); // ! TODO: Replace with AppDataStore.

    // First attempt to restore the Connect Protocol state from local storage.
    let connectState;
    try {
      connectState = JSON.parse(await dataStore.get('connectState'));
    } catch (error) {
      if (error.notFound) { /* Do not throw error if key could not be found. */ }
    }
    console.log('Stored Provider Connect State', connectState);

    // Create a new Connect Protocol instance, restoring the prior state, if any.
    const connect = new ConnectProtocol({ ...connectState });

    let provider;
    let connectData;
    let pinCodeForm;
    let identitiesToDelegate;
    let storedIdentityDids;

    // Listen for messages from other tabs.
    window.addEventListener('message', async event => {
      // Check that the message is from a trusted source.
      // if (event.origin !== 'http://localhost:8080') return;
      console.log('Event Origin:', event.origin);

      // Log the message to the console.
      const connectLink = event.data;
      console.log(`Connect Link: ${connectLink}`);

      provider = await connect.createProvider({ connectLink });

      provider.on('authorizationRequest', async ({ grantDelegation, origin, permissionsRequests, pin }) => {
        console.log('Origin:', origin);
        console.log('Permissions Requests:', permissionsRequests);
        console.log('PIN:', pin);
        connectData = {
          grantDelegation,
          origin,
          permissionsRequests,
          pin
        };

        // Query the Identity Agent's DWN for Identity records.
        const storedIdentities = await agent.identityManager.list();
        storedIdentityDids = storedIdentities.map(identity => identity.did);

        const labels = document.querySelectorAll('label[for^="checkbox"]');
        const inputs = document.querySelectorAll('input[type="checkbox"]');

        storedIdentityDids.forEach((did, index) => {
          labels[index].setAttribute('for', did);
          inputs[index].setAttribute('id', did);
        });

        switchScreen('choose_identities');
      });
    });

    choose_identities_next_button.addEventListener('click', () => {
      console.log('Connect Request:', connectData);
      // Get all the identity selector checkboxes.
      const identityCheckboxes = document.querySelectorAll('#identity_selector input[type="checkbox"]');

      // Filter the checked identityCheckboxes and get their IDs
      identitiesToDelegate = Array.from(identityCheckboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.id);

      console.log('Identities to Delegate:', identitiesToDelegate);

      switchScreen('permissions_request');
    });

    permissions_request_back_button.addEventListener('click', () => {
      switchScreen('choose_identities');
    });

    permissions_request_approve_button.addEventListener('click', async () => {
      // Grant the delegation.
      await connectData.grantDelegation({ identities: identitiesToDelegate });

      // Generate the UI to display the PIN to the user.
      pinCodeForm = createPinCodeForm({ length: 4, value: connectData.pin });

      // Switch to the PIN challenge screen.
      switchScreen('pin_challenge');
    });

    pin_challenge_next_button.addEventListener('click', () => {
      pinCodeForm.removeAllListeners('PIN entry submitted.');
    });

    // Notify the calling window that this window is ready to receive messages.
    if (window.opener) {
      console.log('sending ready message back to calling window');
      window.opener.postMessage('ready', '*');
    }
  </script>

  <script src="script.js"></script>
</body>

</html>