<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local and Remote DWN Example</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="" />
  <link rel="stylesheet" href="./assets/reset.css" />
  <link rel="stylesheet" href="./assets/light.css" media="(prefers-color-scheme: light)" />
  <link rel="stylesheet" href="./assets/dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" href="./assets/global.css" />
  <script type="module" src="https://unpkg.com/dark-mode-toggle"></script>
  <link rel="stylesheet" href="./assets/theme-switch.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/prism-theme-night-owl@1.4.0/build/style.css" rel="stylesheet" />
  <link rel="stylesheet" href="./assets/snippets.css">
  <style>
    /* 
    h2 {
      font-size: large;
      padding-left: 2em;
    }

    .box {
      max-width: 52rem;
      display: flex;
      flex-direction: column;
      border-bottom:gray 1px solid;
      padding-bottom: 2em;
    }

    .box>.row {
      margin-left: 2em;
      margin-right: 2em;
      display: flex;
      align-items: start;
      padding-top: 0.5em;
    }

    .box>.row>label {
      padding-right: 0.5em;
      padding-left: 0.5em;
    }

    .box>.row>button {
      margin-left: auto;
      display: block;
    }

    .box>.row>input[type=text] {
      width: 8em;
    }

    .box>.row>textarea {
      width: 250px;
      height: 125px;
    }
    .box .status {
      display: block;
      margin-left: 2em;
    }
    .green {
      color: green;
    }
    .red {
      color: red;
    }

    .box .recordId {
      font-size: x-small;
    }

    .box .data {
      font-size: small;
      margin: 0;
    }

    .recordRow:nth-child(odd) {
      background-color: #f0f0f0;
    }

    .recordRow:nth-child(even) {
      background-color: #ffffff; 
    }*/
  </style>
</head>

<body>
  <main>
    <h2>Write Records</h2>

    <div class="box">
      <div class="row">
        <textarea id="write_text_data">...data to save</textarea>
        <button type="button" id="write_text_button">Write Text Data</button>
      </div>
      <div id="write_text_result" class="status green"></div>
    </div>

    <h2>Read Records</h2>

    <div class="box">
      <div class="row">
        <div id="query_text_data"><span style="color: gray;">Write at least one record before running a query.</span></div>
        <button type="button" disabled id="query_text_button">Query & Display</button>
      </div>
    </div>


    <p>thing</p>
    <div class="code-wrapper">
      <pre class="language-html" tabindex="0"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-tomorrow.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg==<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span> <span class="token attr-name">referrerpolicy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-referrer<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
      </code></pre><button class="copy-button" data-lang="html">html <svg viewBox="0 0 24 24">
          <path fill="none" d="M0 0h24v24H0z"></path>
          <path
            d="M7 6V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1h-3v3c0 .552-.45 1-1.007 1H4.007A1.001 1.001 0 0 1 3 21l.003-14c0-.552.45-1 1.007-1H7zM5.003 8L5 20h10V8H5.003zM9 6h8v10h2V4H9v2z"
            fill="currentColor"></path>
        </svg></button>
    </div>
    <p>stuff</p>
    <div class="code-wrapper">
      <pre class="language-css" tabindex="0"><code class="language-css"><span class="token comment">/* Import CSS reset and base styles */</span>
  <span class="token atrule"><span class="token rule">@import</span> <span class="token string">"global.css"</span><span class="token punctuation">;</span></span>
  <span class="token atrule"><span class="token rule">@import</span> <span class="token string">"prism.css"</span><span class="token punctuation">;</span></span></code></pre><button class="copy-button" data-lang="css">css <svg viewBox="0 0 24 24">
          <path fill="none" d="M0 0h24v24H0z"></path>
          <path
            d="M7 6V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1h-3v3c0 .552-.45 1-1.007 1H4.007A1.001 1.001 0 0 1 3 21l.003-14c0-.552.45-1 1.007-1H7zM5.003 8L5 20h10V8H5.003zM9 6h8v10h2V4H9v2z"
            fill="currentColor"></path>
        </svg></button>
    </div>
    <p>other stuff</p>
  </main>
  <aside>
    <dark-mode-toggle
    id="dark-mode-toggle"
    class="slider"
    legend="Theme"
    permanent="true"
    appearance="toggle"
  ></dark-mode-toggle>
  </aside>

  <script type="module">
    import { Web5 } from './browser.mjs';
    
    const web5 = new Web5();
    let response;

    // Create a new ION DID and public-private key pair.
    const myDid = await web5.did.create('ion');
    console.log('DID:', myDid);

    // Set Managed DID as running in browser memory and for which keys are available to sign messages.
    web5.did.manager.set(myDid.id, {
      connected: true,
      endpoint: 'app://dwn',
      keys: {
        ['#dwn']: {
          keyPair: did.keys.find(key => key.id === 'dwn').keyPair,
        },
      },
    });

    // Write a plain text record to the in-memory DWN.
    response = await web5.dwn.records.write(myDid.id, {
      author: myDid.id,
      data: 'Hello, world!',
      message: {
        schema: 'foo/bar',
        dataFormat: 'text/plain'
      }
    });
    console.log('WRITE RESPONSE:', response);

    // Query for the record that was just created.
    response = await web5.dwn.records.query(myDid.id, {
      author: myDid.id,
      message: {
        filter: {
          schema: 'foo/bar'
        }
      }
    });
    console.log('QUERY REPONSE:', response);
    // console.log('RESPONSE DATA:', base64UrlToString(response.entries[0].encodedData));

    const existingEntry = response?.entries?.[0];
    if (existingEntry) {
      ;
      const response = await web5.dwn.records.read(myDid.id, {
      author: myDid.id,
      message: {
        recordId: existingEntry.id
      }
    });
    console.log(await response.data);
    }

    // // Write a JSON record to the in-memory DWN.
    // response = await web5.dwn.records.write(myDid.id, {
    //   author: myDid.id,
    //   data: { random: 'stuff' },
    //   message: {
    //     schema: 'foo/baz',
    //     dataFormat: 'application/json'
    //   }
    // });
    // console.log('WRITE RESPONSE:', response.status);

    // // Query for the record that was just created.
    // response = await web5.dwn.records.query(myDid.id, {
    //   author: myDid.id,
    //   message: {
    //     filter: {
    //       schema: 'foo/baz'
    //     }
    //   }
    // });
    // console.log('QUERY REPONSE:', response.entries[0]);
    // console.log('RESPONSE DATA:', base64UrlToObject(response.entries[0].encodedData));

    // write_text_button.addEventListener('click', async event => {
    //   const response = await web5.dwn.records.write(myDid.id, {
    //     author: myDid.id,
    //     data: write_text_data.value,
    //     message: {
    //       schema: 'test/post',
    //     }
    //   });
    //   if (response.status.code === 202) {
    //     write_text_result.textContent = 'Success';
    //     write_text_result.classList.add('green');
    //   } else {
    //     write_text_result.textContent = 'Failed';
    //     write_text_result.classList.add('red');
    //   }

    //   // Enable Query button to retrieve written records.
    //   query_text_button.disabled = false;
    // });

    // query_text_button.addEventListener('click', async event => {
    //   const response = await web5.dwn.records.query(myDid.id, {
    //     author: myDid.id,
    //     message: {
    //       filter: {
    //         schema: 'test/post',
    //       }
    //     }
    //   });
    //   query_text_data.textContent = '';
    //   for (let entry of response.entries) {
    //     const recordId = document.createElement('span');
    //     recordId.classList.add('recordId');
    //     recordId.textContent = `ID: ${entry.recordId}`;

    //     const recordData = document.createElement('p');
    //     recordData.classList.add('data')
    //     const decodedData = base64UrlToString(entry.encodedData);
    //     recordData.textContent = `Data: ${decodedData}`;
        
    //     const recordDiv = document.createElement('div');
    //     recordDiv.classList.add('recordRow')
    //     recordDiv.appendChild(recordId);
    //     recordDiv.appendChild(recordData);

    //     query_text_data.appendChild(recordDiv);
    //   }
    // });


    
    /** Long form ION DID with the DWN Service Endpoint:
     *   service: [
     *     {
     *       'id': 'dwn',
     *       'type': 'DecentralizedWebNode',
     *       'serviceEndpoint': {
     *         'nodes': [
     *            'http://localhost:8085/dwn/',
     *            'http://localhost:8086/dwn/',
     *            'http://localhost:8087/dwn/',
     *         ]
     *       }
     *     }
     *   ]
     *
     * This DID is being used by the `simple-agent` example
     * in this repo, so if you generate a new DID, be sure to
     * update in both places.
     */ 
    const bobDid = 'did:ion:EiA40yRRT5vqIp_DsI0ye6ml5iv8Ee6AE24Dz9aqc1wp7g:eyJkZWx0YSI6eyJwYXRjaGVzIjpbeyJhY3Rpb24iOiJyZXBsYWNlIiwiZG9jdW1lbnQiOnsicHVibGljS2V5cyI6W3siaWQiOiJkd24iLCJwdWJsaWNLZXlKd2siOnsiY3J2Ijoic2VjcDI1NmsxIiwia3R5IjoiRUMiLCJ4IjoiOWJmZjFxbGNhNFF1YVdodWg3NzB3NW9Db1FYcmdaZTFQRkU3c09qb1BPVSIsInkiOiIwem1xdzR2aTktRENnX1o5REdicl9kYk9LaEdTYUVCMGxiekxPQWJBNGdrIn0sInB1cnBvc2VzIjpbImF1dGhlbnRpY2F0aW9uIl0sInR5cGUiOiJKc29uV2ViS2V5MjAyMCJ9XSwic2VydmljZXMiOlt7ImlkIjoiZHduIiwic2VydmljZUVuZHBvaW50Ijp7Im5vZGVzIjpbImh0dHA6Ly9sb2NhbGhvc3Q6ODA4NS9kd24iLCJodHRwOi8vbG9jYWxob3N0OjgwODYvZHduIiwiaHR0cDovL2xvY2FsaG9zdDo4MDg3L2R3biJdfSwidHlwZSI6IkRlY2VudHJhbGl6ZWRXZWJOb2RlIn1dfX1dLCJ1cGRhdGVDb21taXRtZW50IjoiRWlBUHN0V2pLYmp5UlNDdzM3SGxPZm4xZDBfVVlqT25UWGJ0dXl2cy1udGNXdyJ9LCJzdWZmaXhEYXRhIjp7ImRlbHRhSGFzaCI6IkVpQVpPY1E1c1NETU9yYThRRExlY3NiZk1Nd2M0NkEtdXlpdVN4a0JOaVVDT1EiLCJyZWNvdmVyeUNvbW1pdG1lbnQiOiJFaUFKc0loX1R6XzVVMDEwb1VFQTdOY3otVml6Vlk5SWxMMnFRRFVEaTJoa1ZBIn19';
    
    const carolDid = await web5.did.create('ion', {
      services: [
         {
           'id': 'dwn',
           'type': 'DecentralizedWebNode',
           'serviceEndpoint': {
             'nodes': [
                'http://localhost:8085/dwn',
                'http://localhost:8086/dwn',
                'http://localhost:8087/dwn',
             ]
           }
         }
       ]
    });
    console.log(carolDid);

    // Set Managed DID which is connected remotely and for which keys are available to sign messages.
    web5.did.manager.set(carolDid.id, {
      connected: true,
      endpoint: 'http://localhost:8085/dwn',
      keys: {
        ['#dwn']: {
          keyPair: did.keys.find(key => key.id === 'dwn').keyPair,
        },
      },
    });

    // // Write a JSON record to the remote DWN.
    // response = await web5.dwn.records.write(carolDid.id, {
    //   author: carolDid.id,
    //   data: { random: 'stuff' },
    //   message: {
    //     protocol: 'test',
    //     schema: 'test/post',
    //     dataFormat: 'application/json'
    //   }
    // });
    // console.log('Target bobDid write response:', response);

    // // Query for the JSON record to the remote DWN.
    // response = await web5.dwn.records.query(bobDid, {
    //   author: myDid.id,
    //   message: {
    //     filter: {
    //       protocol: 'test',
    //       schema: 'test/post',
    //       dataFormat: 'application/json'
    //     }
    //   }
    // });
    // console.log('Target bobDid query response:', response);

    // const existingEntry = response?.entries?.[0];
    // if (existingEntry) {
      // response = await web5.dwn.records.read(bobDid, {
      //   author: myDid.id,
      //   message: {
      //     // recordId: existingEntry.id
      //     recordId: 'bafyreicsmdtrvgirbesrti2ljdgqcqdyr2bekgd5a7lnuxdlhdfvft6woy'
      //   }
      // });
    // }

    // Convenience functions to decode data returned by queries
    function base64UrlToString(encodedData) {
      return web5.dwn.sdk.Encoder.bytesToString(web5.dwn.sdk.Encoder.base64UrlToBytes(encodedData));
    }

    function base64UrlToObject(encodedData) {
      return web5.dwn.sdk.Encoder.base64UrlToObject(encodedData);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/toolbar/prism-toolbar.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.js"></script> -->
</body>

</html>